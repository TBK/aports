# Maintainer: TBK <alpine@jjtc.eu>
# Contributor: TBK <alpine@jjtc.eu>
pkgname=hhvm
_pkgname=HHVM
pkgver=3.21.0
pkgrel=0
pkgdesc="HHVM is an open-source virtual machine designed for executing programs written in Hack and PHP."
url="https://hhvm.com"
arch="all"
license="PHP-3 BSD LGPL2 MIT Zend"
subpackages="$pkgname-dev $pkgname-doc $pkgname-proxygen"
depends=""
makedepends="acl-dev attr-dev autoconf automake binutils binutils-dev binutils-gold bison boost-dev bzip2-dev cloog-dev
cmake curl-dev expat-dev freetype-dev gawk gcc gd-dev gettext-dev git glog-dev gmp-dev gnu-libiconv-dev
gperf icu-dev imagemagick-dev imap-dev inotify-tools inotify-tools-dev jemalloc-dev krb5-dev libcap-dev
libdwarf-dev libelf-dev libevent-dev libgomp libldap libmcrypt-dev libmemcached-dev libpcre16 libpcre32
libre2-dev libressl-dev libstdc++ libtbb-dev libtool libunwind-dev libxml2-dev libxslt-dev libzip-dev linux-headers lz4-dev
mariadb-dev memcached memcached-dev mpfr-dev ncurses-dev ocaml oniguruma-dev pkgconf postgresql-dev readline-dev
snappy-dev sqlite-dev subversion watchman yaml-dev zlib-dev zstd-dev"
source="https://github.com/facebook/hhvm/archive/$_pkgname-$pkgver.tar.gz
  FindLibMagickWand.patch
  FindSnappy.patch
  webscalesqlclient-CMakeLists.patch
  webscalesqlclient-ssl.patch
  "
builddir="$srcdir/$pkgname-$_pkgname-$pkgver"

prepare() {
  cd "$builddir"

  rmdir third-party
  git submodule add -f https://github.com/hhvm/hhvm-third-party.git third-party
  git submodule update --init --recursive

  default_prepare
}

build() {
  cd "$builddir"

  cmake CMakeLists.txt \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCONFDIR=/etc/$pkgname \
		-DRUNDIR=/run/$pkgname
  make -j64 hhvm
}

check() {
  cd "$builddir"
  make check
  ./hhvm/hhvm test/run test/quick
}

package() {
  cd "$builddir"

  make DESTDIR="$pkgdir" install
}

dev() {
  default_dev
}
 
doc() { 
  default_doc

  cd "$builddir"

  mkdir -p "$subpkgdir"/usr/share/doc/$pkgname
  cp CODING_STANDARDS CREDITS EXTENSIONS INSTALL LICENSE NEWS \
    README* UPGRADING* \
    "$subpkgdir"/usr/share/doc/$pkgname/
}
sha512sums="cad2503e2942944d3ee56626a61e39495b34b83aeeeb2ba9935a2bf714e27720ff744a4d752833d5835c6bccdd147978ff0c03914113628fe0162ba9b386550a  HHVM-3.21.0.tar.gz
1bc0769ce08c8b89b4c752bce6fc6f4f85251790d6221514bac113f58bd8374166061c969c9b6a8cd806872014db131505191a0faa6d53ebc277490b809c524b  FindLibMagickWand.patch
6a0670231c8d50d7a9806e3db5a4d93d8c7f8046f44e081093dbc689d548e04d8f4a9066c6467d300bf9e36619a99066149f5c17bcb723bc031cd70674feee40  FindSnappy.patch
b5f34cadf191cec150f61a31cebd5b161c5ae5e03724d780abf7fba956e51c89e61651d0adb34b0dca73a30e6c933fa1a02969f816f149d1f8b1920b60c9cc70  webscalesqlclient-CMakeLists.patch
a86371525d6b26fb5b4b9b92be01bcfa725ce106d662767f6787c10ca42b043b91fab995b2623b9d7229c9d3fe433c24ecf515c616ff8b91a00cbcef0612e7db  webscalesqlclient-ssl.patch"
